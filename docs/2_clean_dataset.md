# 2_clean_dataset.py Documentation

This document provides details about the `2_clean_dataset.py` script.

## What does this code do?

This script is responsible for cleaning the annotation files generated by `1_dataset_generator.py`. The cleaning process involves filtering the annotations based on a predefined list of allowed surgical instruments. This is useful for creating specialized subsets of the dataset that focus on specific instruments or scenarios.

## What is the input of this code?

The script takes the JSON annotation files located in the `dataset/` directory as input. Each JSON file corresponds to a video and contains the raw, unfiltered annotations.

## What is the output of this code?

The script creates a new JSON file named `annotation_cleaned.json` in the same video-specific subdirectory. It does not modify the original `annotation.json` file.

## What are the configurations?

The script's behavior can be customized through the following configuration variables found at the beginning of the file:

-   `DATASET_ROOT`: The root directory where the dataset's JSON files are stored. Default is `"dataset/"`.
-   `ALWAYS_KEPT_CLASSES`: A set of class names that should always be preserved in the dataset, regardless of the `allowed_instruments` list. This typically includes non-instrument classes like "Cornea" and "Pupil".
-   `allowed_instruments`: This is not a hardcoded configuration in the script itself but is passed as a command-line argument when running the script.

## The algorithm that is implemented in the code

1.  **Argument Parsing**: The script is run with command-line arguments that specify which videos to process and which instruments to allow.
2.  **File Discovery**: The script locates the `annotation.json` file for each specified video.
3.  **Iteration and Loading**: It iterates through each specified video's `annotation.json` file, loading its content into a Python dictionary.
4.  **Defining Allowed Classes**: The `allowed_instruments` provided via the command line are combined with the `ALWAYS_KEPT_CLASSES` to form a final set of classes to keep.
5.  **Annotation Filtering**: The `clean_annotations` function is called for each loaded JSON data structure.
    -   It iterates through every annotation entry in the `annotations` list of the JSON data.
    -   For each annotation, it checks if the class of the annotated object is present in the `final_allowed_classes` set.
    -   If the class is allowed, the annotation is kept. Otherwise, it is discarded.
6.  **Saving the Cleaned File**: The modified Python dictionary is written to a new file, `annotation_cleaned.json`.
7.  **Reporting**: The script prints out the number of annotations that were removed from each file.

## How is the structure of the dataset after running each code?

A new file, `annotation_cleaned.json`, is added to each processed video's directory. The structure of this JSON file is identical to `annotation.json`, but the `annotations` list will only contain entries for the allowed classes.

The dataset consists of 12 classes:
- **Instruments**: "Cannula", "Cap-Cystotome", "Cap-Forceps", "Forceps", "IA-Handpiece", "Lens-Injector", "Phaco-Handpiece", "Primary-Knife", "Second-Instrument", "Secondary-Knife"
- **Tissues**: "Cornea", "Pupil"

Example of a JSON file *before* cleaning:
```json
{
  "annotations": [
    {"frame": 0, "id": 1, "class": "Phaco-Handpiece", "bbox": [...]},
    {"frame": 0, "id": 2, "class": "Cornea", "bbox": [...]},
    {"frame": 0, "id": 3, "class": "Forceps", "bbox": [...]}
  ],
  ...
}
```

Example of the same JSON file *after* cleaning, assuming `Forceps` is not in `allowed_instruments`:
```json
{
  "annotations": [
    {"frame": 0, "id": 1, "class": "Phaco-Handpiece", "bbox": [...]},
    {"frame": 0, "id": 2, "class": "Cornea", "bbox": [...]}
  ],
  ...
}
```
